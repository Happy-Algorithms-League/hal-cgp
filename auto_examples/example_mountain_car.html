

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example: Solving an OpenAI Gym environment with CGP. &mdash; hal-cgp 0.2.0dev documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/msmb.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/versions.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API reference" href="../api_reference/api_reference.html" />
    <link rel="prev" title="Example for evolutionary regression" href="example_evo_regression.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> hal-cgp
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage.html">Basic usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="example_caching.html">Example demonstrating the use of the caching decorator.</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_parametrized_nodes.html">Example for evolutionary regression with parametrized nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_differential_evo_regression.html">Example for differential evolutionary regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_evo_regression.html">Example for evolutionary regression</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example: Solving an OpenAI Gym environment with CGP.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/api_reference.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citation.html">Citation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hal-cgp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Examples</a> &raquo;</li>
        
      <li>Example: Solving an OpenAI Gym environment with CGP.</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/auto_examples/example_mountain_car.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-example-mountain-car-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="example-solving-an-openai-gym-environment-with-cgp">
<span id="sphx-glr-auto-examples-example-mountain-car-py"></span><h1>Example: Solving an OpenAI Gym environment with CGP.<a class="headerlink" href="#example-solving-an-openai-gym-environment-with-cgp" title="Permalink to this headline">¶</a></h1>
<p>This examples demonstrates how to solve an OpenAI Gym environment
(<a class="reference external" href="https://gym.openai.com/envs/">https://gym.openai.com/envs/</a>) with Cartesian genetic programming. We
choose the “MountainCarContinuous” environment due to its continuous
observation and action spaces.</p>
<p>Preparatory steps:
Install the OpenAI Gym package: <cite>pip install gym</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gym</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
        <span class="s2">&quot;Failed to import the OpenAI Gym package. Please install it via `pip install gym`.&quot;</span>
    <span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">cgp</span>
</pre></div>
</div>
<p>For more flexibility in the evolved expressions, we define two
constants that can be used in the expressions, with values 0.1 and
10.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ConstantFloatZeroPointOne</span><span class="p">(</span><span class="n">cgp</span><span class="o">.</span><span class="n">ConstantFloat</span><span class="p">):</span>
    <span class="n">_def_output</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>


<span class="k">class</span> <span class="nc">ConstantFloatTen</span><span class="p">(</span><span class="n">cgp</span><span class="o">.</span><span class="n">ConstantFloat</span><span class="p">):</span>
    <span class="n">_def_output</span> <span class="o">=</span> <span class="s2">&quot;10.0&quot;</span>
</pre></div>
</div>
<p>Then we define the objective function for the evolution.  The inner
objective accepts a Python callable as input. This callable
determines the action taken by the agent upon receiving observations
from the environment. The fitness of the given callable on the task
is then computed as the cumulative reward over a fixed number of
episodes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inner_objective</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">n_runs_per_individual</span><span class="p">,</span> <span class="n">n_total_steps</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">render</span><span class="p">):</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCarContinuous-v0&quot;</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">cum_reward_all_episodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs_per_individual</span><span class="p">):</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">cum_reward_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_total_steps</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
                <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

            <span class="n">continuous_action</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
            <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">continuous_action</span><span class="p">)</span>
            <span class="n">cum_reward_this_episode</span> <span class="o">+=</span> <span class="n">reward</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">cum_reward_all_episodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cum_reward_this_episode</span><span class="p">)</span>
                <span class="n">cum_reward_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cum_reward_all_episodes</span>
</pre></div>
</div>
<p>The objective then takes an individual, evaluates the inner
objective, and updates the fitness of the individual. If the
expression of the individual leads to a division by zero, this error
is caught and the individual gets a fitness of -infinity assigned.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">n_runs_per_individual</span><span class="p">,</span> <span class="n">n_total_steps</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ind</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">to_func</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>  <span class="c1"># ignore warnings due to zero division</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;divide by zero encountered in double_scalars&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;invalid value encountered in double_scalars&quot;</span>
            <span class="p">)</span>
            <span class="n">cum_reward_all_episodes</span> <span class="o">=</span> <span class="n">inner_objective</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">n_runs_per_individual</span><span class="p">,</span> <span class="n">n_total_steps</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="c1"># more episodes are better, more reward is better</span>
        <span class="n">n_episodes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cum_reward_all_episodes</span><span class="p">))</span>
        <span class="n">mean_cum_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cum_reward_all_episodes</span><span class="p">)</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="n">n_episodes</span> <span class="o">/</span> <span class="n">n_runs_per_individual</span> <span class="o">+</span> <span class="n">mean_cum_reward</span>

    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">return</span> <span class="n">ind</span>
</pre></div>
</div>
<p>We then define the main loop for the evolution, which consists of:</p>
<ul class="simple">
<li><p>parameters for the population, the genome of individuals, and the evolutionary algorithm.</p></li>
<li><p>creating a Population instance and instantiating the evolutionary algorithm.</p></li>
<li><p>defining a recording callback closure for bookkeeping of the progression of the evolution.</p></li>
</ul>
<p>Finally, we call the <cite>evolve</cite> method to perform the evolutionary search.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>

    <span class="n">objective_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_runs_per_individual&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;n_total_steps&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">}</span>

    <span class="n">population_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_parents&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;mutation_rate&quot;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">seed</span><span class="p">}</span>

    <span class="n">genome_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n_inputs&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;n_outputs&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;n_columns&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s2">&quot;n_rows&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;levels_back&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;primitives&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">cgp</span><span class="o">.</span><span class="n">Add</span><span class="p">,</span>
            <span class="n">cgp</span><span class="o">.</span><span class="n">Sub</span><span class="p">,</span>
            <span class="n">cgp</span><span class="o">.</span><span class="n">Mul</span><span class="p">,</span>
            <span class="n">cgp</span><span class="o">.</span><span class="n">Div</span><span class="p">,</span>
            <span class="n">cgp</span><span class="o">.</span><span class="n">ConstantFloat</span><span class="p">,</span>
            <span class="n">ConstantFloatZeroPointOne</span><span class="p">,</span>
            <span class="n">ConstantFloatTen</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>

    <span class="n">ea_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_offsprings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;tournament_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;n_processes&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

    <span class="n">evolve_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;max_generations&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;min_fitness&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">}</span>

    <span class="n">pop</span> <span class="o">=</span> <span class="n">cgp</span><span class="o">.</span><span class="n">Population</span><span class="p">(</span><span class="o">**</span><span class="n">population_params</span><span class="p">,</span> <span class="n">genome_params</span><span class="o">=</span><span class="n">genome_params</span><span class="p">)</span>

    <span class="n">ea</span> <span class="o">=</span> <span class="n">cgp</span><span class="o">.</span><span class="n">ea</span><span class="o">.</span><span class="n">MuPlusLambda</span><span class="p">(</span><span class="o">**</span><span class="n">ea_params</span><span class="p">)</span>

    <span class="n">history</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">history</span><span class="p">[</span><span class="s2">&quot;expr_champion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">recording_callback</span><span class="p">(</span><span class="n">pop</span><span class="p">):</span>
        <span class="n">history</span><span class="p">[</span><span class="s2">&quot;expr_champion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">champion</span><span class="o">.</span><span class="n">to_sympy</span><span class="p">())</span>
        <span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">champion</span><span class="o">.</span><span class="n">fitness</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">objective</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">n_runs_per_individual</span><span class="o">=</span><span class="n">objective_params</span><span class="p">[</span><span class="s2">&quot;n_runs_per_individual&quot;</span><span class="p">],</span>
        <span class="n">n_total_steps</span><span class="o">=</span><span class="n">objective_params</span><span class="p">[</span><span class="s2">&quot;n_total_steps&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">cgp</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="o">**</span><span class="n">evolve_params</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">recording_callback</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">history</span><span class="p">,</span> <span class="n">pop</span><span class="o">.</span><span class="n">champion</span>
</pre></div>
</div>
<p>For visualization, we define a function to plot the fitness over generations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_fitness_over_generation_index</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">6.0</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">1.618</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Generation index&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fitness champion&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;example_mountain_car.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
<p>We define a function that checks whether the best expression
fulfills the “solving criteria”, i.e., average reward of at least
90.0 over 100 consecutive
trials. (<a class="reference external" href="https://github.com/openai/gym/wiki/Leaderboard#mountaincarcontinuous-v0">https://github.com/openai/gym/wiki/Leaderboard#mountaincarcontinuous-v0</a>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evaluate_champion</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCarContinuous-v0&quot;</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">to_func</span><span class="p">()</span>

    <span class="n">cum_reward_all_episodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cum_reward_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cum_reward_all_episodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>

        <span class="n">continuous_action</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">continuous_action</span><span class="p">)</span>
        <span class="n">cum_reward_this_episode</span> <span class="o">+=</span> <span class="n">reward</span>

        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">cum_reward_all_episodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cum_reward_this_episode</span><span class="p">)</span>
            <span class="n">cum_reward_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">cum_reward_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cum_reward_all_episodes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;average reward over 100 consecutive trials: </span><span class="si">{</span><span class="n">cum_reward_average</span><span class="si">:</span><span class="s2">.05f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cum_reward_average</span> <span class="o">&gt;=</span> <span class="mf">90.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt; environment solved!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cum_reward_all_episodes</span>
</pre></div>
</div>
<p>Furthermore, we define a function for visualizing the agent’s behaviour for
each expression that increase over the currently best performing individual.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_behaviour_for_evolutionary_jumps</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">only_final_solution</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n_runs_per_individual</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">n_total_steps</span> <span class="o">=</span> <span class="mi">999</span>

    <span class="n">max_fitness</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fitness</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">only_final_solution</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">fitness</span> <span class="o">&gt;</span> <span class="n">max_fitness</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;expr_champion&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">expr_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;x_0&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;x_1&quot;</span><span class="p">,</span> <span class="s2">&quot;dx/dt&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;visualizing behaviour for expression &quot;</span><span class="si">{</span><span class="n">expr_str</span><span class="si">}</span><span class="s1">&quot; (fitness: </span><span class="si">{</span><span class="n">fitness</span><span class="si">:</span><span class="s1">.05f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

            <span class="n">x_0</span><span class="p">,</span> <span class="n">x_1</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x_0, x_1&quot;</span><span class="p">)</span>
            <span class="n">f_lambdify</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">lambdify</span><span class="p">([</span><span class="n">x_0</span><span class="p">,</span> <span class="n">x_1</span><span class="p">],</span> <span class="n">expr</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">f_lambdify</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="n">inner_objective</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">n_runs_per_individual</span><span class="p">,</span> <span class="n">n_total_steps</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">max_fitness</span> <span class="o">=</span> <span class="n">fitness</span>
</pre></div>
</div>
<p>Finally, we execute the evolution and visualize the results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">seed</span> <span class="o">=</span> <span class="mi">818821</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting evolution&quot;</span><span class="p">)</span>
    <span class="n">history</span><span class="p">,</span> <span class="n">champion</span> <span class="o">=</span> <span class="n">evolve</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evolution ended&quot;</span><span class="p">)</span>

    <span class="n">max_fitness</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;fitness_champion&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">best_expr</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;expr_champion&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">best_expr_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_expr</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;x_0&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;x_1&quot;</span><span class="p">,</span> <span class="s2">&quot;dx/dt&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;solution with highest fitness: &quot;</span><span class="si">{</span><span class="n">best_expr_str</span><span class="si">}</span><span class="s1">&quot; (fitness: </span><span class="si">{</span><span class="n">max_fitness</span><span class="si">:</span><span class="s1">.05f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="n">plot_fitness_over_generation_index</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
    <span class="n">evaluate_champion</span><span class="p">(</span><span class="n">champion</span><span class="p">)</span>
    <span class="n">visualize_behaviour_for_evolutionary_jumps</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-example-mountain-car-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/6d1d18ac3f4f0be69ba27614e36538dc/example_mountain_car.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">example_mountain_car.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/f97c2fd5f379c8465cdcffb7ed749c92/example_mountain_car.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">example_mountain_car.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api_reference/api_reference.html" class="btn btn-neutral float-right" title="API reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="example_evo_regression.html" class="btn btn-neutral float-left" title="Example for evolutionary regression" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Happy Algorithms League

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <script>
    var versions_json_url = ''
</script>

<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"></span>
        0.2.0dev
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
        <dl id="versionselector">
            <dt>Other Versions</dt>
        </dl>

    </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>